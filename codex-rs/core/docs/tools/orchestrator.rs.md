# orchestrator.rs

## 文件作用

本文件实现了工具编排器（ToolOrchestrator），负责协调工具执行的完整生命周期，包括用户审批、沙箱选择、执行尝试和失败重试等关键流程。它是工具安全执行的核心组件。

## 主要结构体

- **ToolOrchestrator**: 工具编排器，管理沙箱和工具执行流程

## 主要方法

- **new()**: 创建新的工具编排器实例
- **run()**: 执行工具的完整生命周期流程，包括：
  - 审批阶段：根据策略请求用户审批
  - 首次尝试：在选定的沙箱中执行工具
  - 失败处理：如果沙箱拒绝，可能请求升级权限并重试

## 核心流程

### 1. 审批阶段
- 根据审批策略决定是否需要初始审批
- 对需要沙箱重试的命令进行风险评估
- 使用工具的 `start_approval_async` 方法请求审批
- 记录审批决策到 OTEL 遥测系统

### 2. 首次执行尝试
- 根据沙箱策略选择初始沙箱类型
- 支持请求直接使用提升权限（escalated）的首次尝试
- 在沙箱环境中执行工具

### 3. 失败重试逻辑
- 捕获沙箱拒绝错误（SandboxErr::Denied）
- 根据审批策略决定是否可以无沙箱重试
- 对需要重试的命令进行风险评估
- 请求用户审批无沙箱执行
- 在无沙箱环境中重新执行工具

## 辅助函数

- **build_denial_reason_from_output()**: 构建沙箱拒绝的简洁原因描述

## 与其他模块的关系

- 使用 `sandboxing` 模块的 `SandboxManager` 进行沙箱管理
- 依赖 `sandboxing` 模块的 trait（`ToolRuntime`、`Approvable`、`Sandboxable`）
- 与 `error` 模块集成处理各种错误类型
- 使用 `codex` 模块的 `Session` 和 `TurnContext` 提供执行环境
- 集成风险评估和审批流程
- 记录工具决策到 OTEL 遥测系统
